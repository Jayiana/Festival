@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IHttpContextAccessor HttpContextAccessor
@rendermode InteractiveServer

<nav class="festival-navbar">
    <div class="logo">
        <img src="/images/Showtime-logo.png" alt="ShowTime" />
    </div>

    <div class="nav-links">
        <a href="/" class="nav-link"><i class="fas fa-house"></i> Home</a>
        <a href="/artists" class="nav-link"><i class="fas fa-microphone"></i> Artists</a>
        <a href="/festivals" class="nav-link"><i class="fas fa-music"></i> Festivals</a>
        <a href="/lineups" class="nav-link"><i class="fas fa-users"></i> Lineups</a>
        <a href="/booking" class="nav-link"><i class="fas fa-calendar-check"></i> Booking</a>
        <a href="/accommodation" class="nav-link"><i class="fas fa-bed"></i> Accommodation</a>

        <input type="text" placeholder="Search artists/festivals..." class="search-bar" />
    </div>

    <div class="user-profile">
        <div class="profile-circle" @onclick="ToggleDropdown" data-tooltip="@(isAuthenticated ? "User Profile" : "Click to Login")">
            <img src="/images/default-profile.png" alt="User Profile" class="profile-image" />
            <div class="profile-overlay">
                <i class="fas fa-user"></i>
            </div>
            @if (!isAuthenticated)
            {
                <div class="login-indicator">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
            }
        </div>
        @if (isAuthenticated && showDropdown)
        {
            <div class="profile-dropdown">
                <div class="profile-info">
                    <span>@userEmail</span>
                </div>
                <button class="logout-btn" @onclick="Logout">Logout</button>
            </div>
        }
    </div>
    
    <!-- Navbar Decorations -->
    <div class="navbar-decoration">
        <div class="nav-sparkle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="nav-sparkle" style="right: 15%; animation-delay: 2s;"></div>
        <div class="nav-sparkle" style="left: 50%; animation-delay: 4s;"></div>
    </div>
</nav>

@code {
    private bool isAuthenticated = false;
    private string? userEmail;
    private bool showDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthenticationState();
    }

    private async Task CheckAuthenticationState()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated == true;

        if (isAuthenticated)
        {
            userEmail = user.FindFirst(ClaimTypes.Email)?.Value;
        }
    }


    private void ToggleDropdown()
    {
        if (!isAuthenticated)
        {
            NavManager.NavigateTo("/login");
        }
        else
        {
            showDropdown = !showDropdown;
        }
    }

    private void Logout()
    {
        showDropdown = false;
        NavManager.NavigateTo("/logout", forceLoad: true);
    }

}

<style>
.profile-dropdown {
    position: absolute;
    top: 60px;
    right: 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-width: 180px;
    z-index: 1000;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
.profile-info {
    margin-bottom: 1rem;
    font-weight: bold;
    color: #333;
}
.logout-btn {
    background: #c00;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s;
}
.logout-btn:hover {
    background: #a00;
}
</style>

